<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Knowledge Analyser</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial,sans-serif; margin:10px; background:#f5f5f5; color:#333; }
h2 { text-align:center; font-size:1.5rem; }
#dropZone { border: 2px dashed #007bff; padding:20px; text-align:center; border-radius:10px; margin:10px auto; max-width:400px; }
#dropZone.dragover { background:#e0f0ff; }
button { display:block; margin:10px auto; padding:12px; font-size:1rem; border-radius:8px; width:90%; max-width:300px; border:none; background:#007bff; color:#fff; cursor:pointer; }
button:hover { background:#0056b3; }
.question-card { margin:10px auto; padding:15px; border-radius:10px; background:#fff; max-width:600px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.options label { display:block; margin:8px 0; padding:8px; border-radius:6px; background:#fafafa; border:1px solid #ccc; cursor:pointer; font-size:1rem; }
.options input { margin-right:10px; }
#result { text-align:center; max-width:600px; margin:20px auto; }
canvas { max-width:90%; height:auto !important; margin:20px auto; }
#timer { text-align:center; font-weight:bold; font-size:1.2rem; margin-top:10px; }
.hidden { display:none; }
</style>
</head>
<body>

<h2>ðŸ“˜ Student Knowledge Analyser</h2>

<div id="dropZone">Drag & Drop your Excel file(s) here</div>
<input type="file" id="fileInput" multiple class="hidden">

<div id="timer"></div>

<div id="quizArea" class="hidden">
  <div id="questionContainer" class="question-card"></div>
  <button onclick="nextQuestion()" id="nextBtn">Next</button>
</div>

<div id="result" class="hidden">
  <h3>Results</h3>
  <p id="scoreText"></p>
  <canvas id="resultChart"></canvas>
</div>

<script>
let questions = [];
let studentAnswers = {};
let currentIndex = 0;
let totalSeconds = 0;
let timerInterval = null;

function safeStr(val){ return (val===null||val===undefined)?"":String(val).trim(); }

// Drag & drop handling
const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");

dropZone.addEventListener("click", ()=>fileInput.click());
dropZone.addEventListener("dragover", e=>{ e.preventDefault(); dropZone.classList.add("dragover"); });
dropZone.addEventListener("dragleave", e=>{ e.preventDefault(); dropZone.classList.remove("dragover"); });
dropZone.addEventListener("drop", e=>{ e.preventDefault(); dropZone.classList.remove("dragover"); handleFiles(e.dataTransfer.files); });
fileInput.addEventListener("change", e=>handleFiles(e.target.files));

async function handleFiles(files){
  questions = [];
  for(let f of files){
    const data = await f.arrayBuffer();
    const wb = XLSX.read(data,{type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    const qList = json.map(row=>({
      question: safeStr(row.Question),
      options: [row.OptionA,row.OptionB,row.OptionC,row.OptionD].filter(o=>o),
      correct: safeStr(row.Answer)
    }));
    questions = questions.concat(qList);
  }
  if(questions.length){
    dropZone.classList.add("hidden"); // hide drop area
    startQuiz(); // auto-start
  } else {
    alert("No questions found in the Excel file(s)!");
  }
}

// Start quiz
function startQuiz(){
  studentAnswers = {};
  currentIndex = 0;
  totalSeconds = questions.length * 60; // 1 min per question
  document.getElementById("quizArea").classList.remove("hidden");
  renderQuestion();
  startTimer();
}

// Render question
function renderQuestion(){
  const q = questions[currentIndex];
  const container = document.getElementById("questionContainer");
  container.innerHTML = `<h4>Q${currentIndex+1}. ${q.question}</h4>`;
  q.options.forEach(opt=>{
    container.innerHTML += `<div class="options">
      <label>
        <input type="radio" name="q${currentIndex}" value="${safeStr(opt)}"
        ${studentAnswers[currentIndex]===safeStr(opt)?"checked":""}>
        ${opt}
      </label>
    </div>`;
  });
  document.getElementById("nextBtn").innerText = currentIndex===questions.length-1?"Submit":"Next";
}

// Next or submit
function nextQuestion(){
  const selected = document.querySelector(`input[name="q${currentIndex}"]:checked`);
  if(selected) studentAnswers[currentIndex] = safeStr(selected.value);

  if(currentIndex<questions.length-1){
    currentIndex++;
    renderQuestion();
  } else {
    evaluateAnswers();
  }
}

// Timer
function startTimer(){
  updateTimerDisplay();
  timerInterval = setInterval(()=>{
    totalSeconds--;
    if(totalSeconds<=0){
      clearInterval(timerInterval);
      alert("Time is up! Submitting quiz.");
      evaluateAnswers();
    }
    updateTimerDisplay();
  },1000);
}

function updateTimerDisplay(){
  const minutes = Math.floor(totalSeconds/60);
  const seconds = totalSeconds%60;
  document.getElementById("timer").innerText=`Time Left: ${minutes}:${seconds<10?"0":""}${seconds}`;
}

// Evaluate answers
function evaluateAnswers(){
  clearInterval(timerInterval);
  const selected = document.querySelector(`input[name="q${currentIndex}"]:checked`);
  if(selected) studentAnswers[currentIndex] = safeStr(selected.value);

  let correct = 0;
  questions.forEach((q,idx)=>{
    if(safeStr(studentAnswers[idx])===safeStr(q.correct)) correct++;
  });
  const wrong = questions.length - correct;
  document.getElementById("quizArea").classList.add("hidden");
  document.getElementById("result").classList.remove("hidden");
  document.getElementById("scoreText").innerText = `Correct: ${correct}, Wrong: ${wrong}`;

  new Chart(document.getElementById("resultChart"),{
    type:'pie',
    data:{ labels:["Correct","Wrong"], datasets:[{data:[correct,wrong], backgroundColor:["#4CAF50","#F44336"]}] }
  });
}
</script>
</body>
</html>
